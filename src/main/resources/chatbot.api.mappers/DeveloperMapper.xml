<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org/DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="chatbot.api.mappers.DeveloperMapper">

    <select id="getDevice" resultMap="DvlpDevDTO" parameterType="Long">
        SELECT * FROM hrdwr WHERE hrdwr_id=#{hrdwrId}
    </select>


    <!--
    삭제 순서
    derivation -> (btn / rule / event) -> (box / data_model) -> device
    -->

    <!-- 1. derivations 삭제 -->
    <delete id="deleteDerivations" parameterType="Long">
      DELETE FROM derivation WHERE hrdwr_id=#{hrdwrId}
    </delete>

    <!-- btn 삭제 -->
    <delete id="deleteButtons" parameterType="Long">
      DELETE FROM btn WHERE hrdwr_id=#{hrdwrId}
    </delete>

    <!-- 룰 삭제 -->
    <delete id="deleteRules" parameterType="Long">
      DELETE FROM res_box_crs WHERE hrdwr_id=#{hrdwrId}
    </delete>

    <!-- 이벤트 삭제
    <delete id="deleteEvents" parameterType="Long">
      DELETE FROM event WHERE hrdwr_id=#{hrdwrId}
    </delete>
    -->

    <!-- box 삭제 -->
    <delete id="deleteTextBoxes" parameterType="Long">
      DELETE FROM box WHERE hrdwr_id=#{hrdwrId}
    </delete>

    <!-- 데이터 모델 삭제 -->
    <delete id="deleteDataModels" parameterType="Long">
      DELETE FROM data_model WHERE hrdwr_id=#{hrdwrId}
    </delete>

    <!-- device 삭제 -->
    <delete id="deleteDevice" parameterType="Long">
      DELETE FROM hrdwr WHERE hrdwr_id=#{hrdwrId}
    </delete>



    <!--
    삽입 순서
    device -> (box / data_model) -> (btn / rule / event) -> derivation
    -->

    <!-- device 삽입-->
    <insert id="insertDevice" parameterType="chatbot.api.developer.domain.DvlpDevDTO">
        INSERT INTO hrdwr
        (
        hrdwr_id,
        auth_key,
        hrdwr_name,
        user_defined_name,
        hrdwr_type,
        category
        )
        VALUES
        (
        #{dvlpDevDTO.devId},
        #{dvlpDevDTO.authKey},
        #{dvlpDevDTO.devName},
        #{dvlpDevDTO.devDefName},
        #{dvlpDevDTO.devType},
        #{dvlpDevDTO.category}
        )
    </insert>

    <!-- boxes 삽입 -->
    <insert id="insertTextBoxes" parameterType="java.util.Map">
        insert into box (box_id, pre_text, post_text, box_type, hrdwr_id)
        values
        <foreach collection="dvlpBoxDTOList" item="item" separator=" , ">
            (
            #{item.boxId},
            #{item.preText},
            #{item.postText},
            #{item.boxType},
            #{hrdwrId}
            )
        </foreach>
    </insert>

    <!-- 데이터 모델 삽입 -->
    <insert id="insertDataModels" parameterType="java.util.Map">
        insert into data_model (data_type, mode_type, is_ev, data_key, hrdwr_id)
        values
        <foreach collection="dvlpDataModelDTOList" item="item" separator=" , ">
            (
            #{item.data_type},
            #{item.mode_type},
            #{item.is_ev},
            #{item.data_key},
            #{hrdwrId}
            )
        </foreach>
    </insert>

    <!-- btns 삽입 -->
    <insert id="insertButtons" parameterType="java.util.Map">
        insert into btn (btn_code, btn_name, event_code, idx, box_id, is_spread, btn_type, hrdwr_id)
        values
        <foreach collection="dvlpButtonDTOList" item="item" separator=" , ">
            (
            #{item.btnCode},
            #{item.btnName},
            #{item.evCode},
            #{item.idx},
            #{item.boxId},
            #{item.isSpread},
            #{item.btnType},
            #{hrdwrId}
            )
        </foreach>
    </insert>

    <!-- 룰 삽입 -->
    <insert id="insertRules" parameterType="java.util.Map">
        insert into res_box_crs (rule_type, rule_value, rule_priority, map_val, mod_dev_id, box_id, data_key, mod_id, hrdwr_id)
        values
        <foreach collection="dvlpStateRuleDTOList" item="item" separator=" , ">
            (
            #{item.rule_type},
            #{item.rule_value},
            #{item.rule_priority},
            #{item.map_val},
            #{item.mod_dev_id},
            #{item.box_id},
            #{item.data_key},
            #{item.mod_id},
            #{hrdwrId}
            )
        </foreach>
    </insert>

    <!-- 이벤트 삽입 -->


    <!-- derivations 삽입 -->
    <insert id="insertDerivations" parameterType="java.util.Map">
        insert into derivation (btn_code, upper_box_id, lower_box_id, hrdwr_id)
        values
        <foreach collection="dvlpDerivationDTOList" item="item" separator=" , ">
            (
            #{item.btnCode},
            #{item.upperBoxId},
            #{item.lowerBoxId},
            #{hrdwrId}
            )
        </foreach>
    </insert>



    <resultMap id="DvlpDevDTO" type="chatbot.api.developer.domain.DvlpDevDTO">
        <result property="devId" column="hrdwr_id"/>
        <result property="authKey" column="auth_key"/>
        <result property="devName" column="hrdwr_name"/>
        <result property="devDefName" column="user_defined_name"/>
        <result property="devType" column="hrdwr_type"/>
        <result property="category" column="category"/>
    </resultMap>
</mapper>