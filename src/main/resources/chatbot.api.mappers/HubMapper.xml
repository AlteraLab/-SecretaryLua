<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org/DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="chatbot.api.mappers.HubMapper">



    <!-- hub 레코드 추가, useGeneratedKeys를 사용하면 데이터를 저장할때 keyproperty 컬럼 값이 초기화된 값을 알 수 있다. -->
    <insert id="save" useGeneratedKeys="true" keyProperty="hubSeq" parameterType="chatbot.api.skillHub.domain.HubInfoDto">
        INSERT INTO hub
        (
        hub_sequence,
        hub_name,
        external_ip,
        external_port,
        internal_ip,
        internal_port,
        admin_sequence,
        before_ip,
        last_used_time,
        created_at,
        updated_at,
        state
        )
        VALUES
        (
        #{hubSeq},
        #{hubName},
        #{externalIp},
        #{externalPort},
        #{internalIp},
        #{internalPort},
        #{adminSeq},
        #{beforeIp},
        #{lastUsedTime},
        #{createdAt},
        #{updatedAt},
        #{state}
        )
    </insert>



    <!-- 특정 유저가 사용할 수 있는 모든 허브 검색 -->
    <select id="getUserHub" resultMap="HubInfoDto" parameterType="Long">
        SELECT *
        FROM hub, (SELECT hub_id FROM hub_user WHERE admin_sequence = #{adminSeq}) AS owner
        where hub.hub_sequence = owner.hub_sequence
    </select>



    <!-- 해당 adminId와 일치하는 레코드들을 모두 검색 -->
    <select id="getHubInfoByAdminId" resultType="chatbot.api.skillHub.domain.HubTableVo" parameterType="chatbot.api.skillHub.domain.HubInfoDto">
        SELECT * FROM hub WHERE admin_sequence = #{adminId}
    </select>



    <!-- hubSeq에 대한 hubInfo를  (사용자 추가할 때 쓰임) -->
    <select id="getHubInfo" resultMap="HubInfoDto" parameterType="Long">
        SELECT * FROM hub WHERE hub_sequence = #{hubSeq}
    </select>



    <!-- delete hub record -->
    <delete id="deleteHub" parameterType="Long">
        DELETE FROM hub WHERE hub_sequence = #{hubSeq}
    </delete>



    <!-- implicit delete hub schedule -->
    <delete id="implicitDeleteHub" parameterType="Date">
        DELETE h, r
        FROM hub AS h
        LEFT JOIN hub_user AS r
        ON h.hub_sequence = r.hub_sequence
        WHERE h.last_used_time <![CDATA[ < ]]> #{expireDate}
    </delete>

<!--
    <delete id="implicitDeleteHub" parameterType="Date">
        DELETE r, h
        FROM hub_user AS r INNER JOIN hub AS h
        ON h.hub_sequence = r.hub_sequence
        WHERE h.last_used_time <![CDATA[ < ]]> #{expireDate}
    </delete>

    <delete id="implicitDeleteHub" parameterType="Date">
        DELETE h
        FROM hub AS h INNER JOIN hub_user AS r
        ON h.hub_sequence = r.hub_sequence
        WHERE h.last_used_time <![CDATA[ < ]]> #{expireDate}
    </delete>
    -->


    <!-- editHub -->
    <update id="editHubAboutIpAndPort" parameterType="hashmap">
		UPDATE hub
		SET
		external_ip = #{exIp},
		internal_ip = #{inIp},
		external_port = #{exPort},
		internal_port = #{inPort}
		WHERE hub_sequence = #{hubSeq}
	</update>



    <!-- 처음 메인 페이지로 접속 했을때, 유저가 사용 가능한 허브 목록들 모두 select -->
    <select id="getHubsInfoByUserId" resultType="chatbot.api.skillHub.domain.HubsVo" parameterType="Long">
        SELECT
        h.hub_sequence,
        h.admin_sequence,
        h.hub_name,
        h.external_ip,
        h.external_port,
        h.internal_ip,
        h.internal_port,
        h.before_ip,
        h.last_used_time,
        h.created_at,
        h.updated_at,
        h.state,
        r.role
        FROM hub_user AS r INNER JOIN hub AS h
        ON r.hub_sequence = h.hub_sequence
        WHERE r.user_sequence = #{userId}
    </select>


    <!-- ################################################################################### -->



    <resultMap id="HubInfoDto" type="chatbot.api.skillHub.domain.HubInfoDto">
        <result property="hubSeq" column="hub_sequence"/>
        <result property="adminSeq" column="admin_sequence"/>
        <result property="hubName" column="hub_name"/>
        <result property="externalIp" column="external_ip"/>
        <result property="externalPort" column="external_port"/>
        <result property="internalIp" column="internal_ip"/>
        <result property="internalPort" column="internal_port"/>
        <result property="beforeIp" column="before_ip"/>
        <result property="lastUsedTime" column="last_used_time"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="state" column="state"/>
    </resultMap>


<!--
    <parameterMap id="HubInfoDto" type="chatbot.api.skillHub.domain.HubInfoDto">
        <parameter property="hubSeq"/>
        <parameter property="adminSeq"/>
        <parameter property="hubName"/>
        <parameter property="externalIp"/>
        <parameter property="externalPort"/>
        <parameter property="internalIp"/>
        <parameter property="internalPort"/>
        <parameter property="beforeIp"/>
        <parameter property="lastUsedTime"/>
    </parameterMap>-->

</mapper>